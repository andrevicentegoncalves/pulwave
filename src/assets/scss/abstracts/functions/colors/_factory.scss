@use 'sass:map';
@use 'sass:math';
@use 'sass:color';
@use 'sass:string';

// ============================================================================= //
//                    FUNCTIONS: COLOR FACTORY (REDESIGN)                        //
// ============================================================================= //

// This factory creates colors from primitives and provides utilities for
// accessibility validation, contrast checking, and automated color assignment.

// =============================================================================
// PRIMARY FACTORY FUNCTION
// =============================================================================

/// Creates a color from the primitive configuration
/// @param {Map} $color-config - Color primitive configuration (hue, saturation)
/// @param {Map} $custom-lightness - Custom lightness overrides per family
/// @param {Map} $base-lightness - Base lightness scale (fallback)
/// @param {String} $family - Color family name (e.g., 'primary', 'neutral')
/// @param {Number} $weight - Color weight (0-950)
/// @return {Color} HSL color value
/// @example
///   create-color($primitives, $custom, $base, 'primary', 500)
///   // => hsl(220, 100%, 54%)

@function create-color($color-config, $custom-lightness, $base-lightness, $family, $weight: 500) {
  // Validate color family exists
  @if not map.has-key($color-config, $family) {
    @error "Color family '#{$family}' not found in configuration. Available families: #{map.keys($color-config)}";
  }
  
  // Validate weight exists
  @if not map.has-key($base-lightness, $weight) and not (map.has-key($custom-lightness, $family) and map.has-key(map.get($custom-lightness, $family), $weight)) {
    @error "Weight '#{$weight}' not found. Available weights: #{map.keys($base-lightness)}";
  }
  
  // Get hue and saturation from primitive config
  $color-def: map.get($color-config, $family);
  $hue: map.get($color-def, 'hue');
  $saturation: map.get($color-def, 'saturation');
  
  // Determine lightness (custom override > base scale)
  $lightness: null;
  
  // Check for custom lightness override
  @if $custom-lightness and map.has-key($custom-lightness, $family) {
    $family-overrides: map.get($custom-lightness, $family);
    @if map.has-key($family-overrides, $weight) {
      $lightness: map.get($family-overrides, $weight);
    }
  }
  
  // Fallback to base lightness if no override
  @if not $lightness {
    $lightness: map.get($base-lightness, $weight);
  }
  
  // Return HSL color
  @return hsl($hue, $saturation, $lightness);
}

// =============================================================================
// COLOR MANIPULATION UTILITIES
// =============================================================================

/// Lightens a color by a percentage
/// @param {Color} $color - Base color
/// @param {Number} $amount - Percentage to lighten (0-100%)
/// @return {Color} Lightened color

@function lighten-color($color, $amount) {
  @return color.adjust($color, $lightness: $amount);
}

/// Darkens a color by a percentage
/// @param {Color} $color - Base color
/// @param {Number} $amount - Percentage to darken (0-100%)
/// @return {Color} Darkened color

@function darken-color($color, $amount) {
  @return color.adjust($color, $lightness: -$amount);
}

/// Increases color saturation
/// @param {Color} $color - Base color
/// @param {Number} $amount - Percentage to saturate (0-100%)
/// @return {Color} Saturated color

@function saturate-color($color, $amount) {
  @return color.adjust($color, $saturation: $amount);
}

/// Decreases color saturation
/// @param {Color} $color - Base color
/// @param {Number} $amount - Percentage to desaturate (0-100%)
/// @return {Color} Desaturated color

@function desaturate-color($color, $amount) {
  @return color.adjust($color, $saturation: -$amount);
}

// =============================================================================
// ACCESSIBILITY UTILITIES
// =============================================================================

/// Calculates relative luminance of a color (WCAG formula)
/// Used for contrast ratio calculations
/// @param {Color} $color - Color to analyze
/// @return {Number} Relative luminance (0-1)
/// @link https://www.w3.org/TR/WCAG20/#relativeluminancedef

@function relative-luminance($color) {
  // Get RGB channels (0-255)
  $r: color.red($color);
  $g: color.green($color);
  $b: color.blue($color);
  
  // Convert to 0-1 range
  $r: math.div($r, 255);
  $g: math.div($g, 255);
  $b: math.div($b, 255);
  
  // Apply gamma correction
  $r: if($r <= 0.03928, math.div($r, 12.92), math.pow(math.div($r + 0.055, 1.055), 2.4));
  $g: if($g <= 0.03928, math.div($g, 12.92), math.pow(math.div($g + 0.055, 1.055), 2.4));
  $b: if($b <= 0.03928, math.div($b, 12.92), math.pow(math.div($b + 0.055, 1.055), 2.4));
  
  // Calculate luminance
  @return (0.2126 * $r) + (0.7152 * $g) + (0.0722 * $b);
}

/// Calculates WCAG contrast ratio between two colors
/// @param {Color} $color1 - First color (usually foreground)
/// @param {Color} $color2 - Second color (usually background)
/// @return {Number} Contrast ratio (1-21)
/// @example
///   contrast-ratio(#000, #fff) // => 21
///   contrast-ratio(#666, #fff) // => 5.74

@function contrast-ratio($color1, $color2) {
  $l1: relative-luminance($color1);
  $l2: relative-luminance($color2);
  
  // Ensure lighter color is numerator
  @if $l1 > $l2 {
    @return math.div($l1 + 0.05, $l2 + 0.05);
  } @else {
    @return math.div($l2 + 0.05, $l1 + 0.05);
  }
}

/// Checks if contrast ratio meets WCAG level
/// @param {Number} $ratio - Contrast ratio
/// @param {String} $level - WCAG level ('AA' or 'AAA')
/// @param {String} $size - Text size ('normal' or 'large')
/// @return {Boolean} True if meets requirements
/// @example
///   meets-wcag(4.5, 'AA', 'normal') // => true
///   meets-wcag(3.2, 'AA', 'normal') // => false

@function meets-wcag($ratio, $level: 'AA', $size: 'normal') {
  // WCAG requirements:
  // Normal text: AA=4.5:1, AAA=7:1
  // Large text:  AA=3:1,   AAA=4.5:1
  
  @if $level == 'AAA' {
    @return if($size == 'large', $ratio >= 4.5, $ratio >= 7);
  } @else {
    @return if($size == 'large', $ratio >= 3, $ratio >= 4.5);
  }
}

/// Automatically selects contrasting text color (light or dark)
/// @param {Color} $background - Background color
/// @param {Color} $light - Light text color (default: white)
/// @param {Color} $dark - Dark text color (default: near-black)
/// @return {Color} Best contrasting text color
/// @example
///   auto-text-color(#3b82f6) // => #000 (dark on light blue)
///   auto-text-color(#1e3a8a) // => #fff (light on dark blue)

@function auto-text-color($background, $light: #ffffff, $dark: #0a0a0a) {
  $light-contrast: contrast-ratio($light, $background);
  $dark-contrast: contrast-ratio($dark, $background);
  
  // Return color with better contrast
  @return if($light-contrast > $dark-contrast, $light, $dark);
}

/// Finds the nearest weight that meets WCAG AA for text on given background
/// @param {Map} $color-config - Color primitive configuration
/// @param {Map} $custom-lightness - Custom lightness overrides
/// @param {Map} $base-lightness - Base lightness scale
/// @param {String} $family - Color family to check
/// @param {Color} $background - Background color
/// @param {String} $level - WCAG level ('AA' or 'AAA')
/// @return {Number} Weight that meets contrast requirement
/// @example
///   accessible-weight($config, $custom, $base, 'primary', #fff, 'AA')
///   // => 700 (primary-700 has 4.5:1 on white)

@function accessible-weight($color-config, $custom-lightness, $base-lightness, $family, $background, $level: 'AA') {
  $weights: (50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950);
  
  @each $weight in $weights {
    $color: create-color($color-config, $custom-lightness, $base-lightness, $family, $weight);
    $ratio: contrast-ratio($color, $background);
    
    @if meets-wcag($ratio, $level, 'normal') {
      @return $weight;
    }
  }
  
  // If no weight meets requirement, return darkest
  @warn "No weight of '#{$family}' meets #{$level} contrast on background #{$background}. Using weight 950.";
  @return 950;
}

// =============================================================================
// COLOR ANALYSIS UTILITIES
// =============================================================================

/// Gets the lightness value from a color
/// @param {Color} $color - Color to analyze
/// @return {Number} Lightness percentage (0-100%)

@function get-lightness($color) {
  @return color.lightness($color);
}

/// Gets the hue value from a color
/// @param {Color} $color - Color to analyze
/// @return {Number} Hue in degrees (0-360)

@function get-hue($color) {
  @return color.hue($color);
}

/// Gets the saturation value from a color
/// @param {Color} $color - Color to analyze
/// @return {Number} Saturation percentage (0-100%)

@function get-saturation($color) {
  @return color.saturation($color);
}

/// Checks if color is light (lightness > 50%)
/// @param {Color} $color - Color to check
/// @return {Boolean} True if light

@function is-light($color) {
  @return color.lightness($color) > 50%;
}

/// Checks if color is dark (lightness <= 50%)
/// @param {Color} $color - Color to check
/// @return {Boolean} True if dark

@function is-dark($color) {
  @return color.lightness($color) <= 50%;
}

// =============================================================================
// INTERACTIVE STATE GENERATORS
// =============================================================================

/// Generates hover state color (darkens by one weight step)
/// @param {Map} $color-config - Color primitive configuration
/// @param {Map} $custom-lightness - Custom lightness overrides
/// @param {Map} $base-lightness - Base lightness scale
/// @param {String} $family - Color family
/// @param {Number} $base-weight - Base weight
/// @return {Color} Hover state color

@function hover-color($color-config, $custom-lightness, $base-lightness, $family, $base-weight: 500) {
  $hover-weight: $base-weight + 100; // One step darker
  @return create-color($color-config, $custom-lightness, $base-lightness, $family, $hover-weight);
}

/// Generates active state color (darkens by two weight steps)
/// @param {Map} $color-config - Color primitive configuration
/// @param {Map} $custom-lightness - Custom lightness overrides
/// @param {Map} $base-lightness - Base lightness scale
/// @param {String} $family - Color family
/// @param {Number} $base-weight - Base weight
/// @return {Color} Active state color

@function active-color($color-config, $custom-lightness, $base-lightness, $family, $base-weight: 500) {
  $active-weight: $base-weight + 200; // Two steps darker
  @return create-color($color-config, $custom-lightness, $base-lightness, $family, $active-weight);
}

/// Generates disabled state color (very light)
/// @param {Map} $color-config - Color primitive configuration
/// @param {Map} $custom-lightness - Custom lightness overrides
/// @param {Map} $base-lightness - Base lightness scale
/// @param {String} $family - Color family
/// @return {Color} Disabled state color

@function disabled-color($color-config, $custom-lightness, $base-lightness, $family) {
  @return create-color($color-config, $custom-lightness, $base-lightness, $family, 200);
}

// =============================================================================
// DEBUGGING & VALIDATION
// =============================================================================

/// Validates color configuration has required keys
/// @param {Map} $config - Color primitive config to validate
/// @return {Boolean} True if valid, throws error if not

@function validate-color-config($config) {
  @each $family, $definition in $config {
    @if not map.has-key($definition, 'hue') {
      @error "Color family '#{$family}' missing required 'hue' key";
    }
    @if not map.has-key($definition, 'saturation') {
      @error "Color family '#{$family}' missing required 'saturation' key";
    }
  }
  @return true;
}

/// Outputs contrast report for debugging
/// @param {Color} $foreground - Foreground color
/// @param {Color} $background - Background color
/// @output Debug message with contrast info

@mixin contrast-report($foreground, $background) {
  $ratio: contrast-ratio($foreground, $background);
  $aa-normal: meets-wcag($ratio, 'AA', 'normal');
  $aaa-normal: meets-wcag($ratio, 'AAA', 'normal');
  
  @debug "Contrast Report:";
  @debug "  Foreground: #{$foreground}";
  @debug "  Background: #{$background}";
  @debug "  Ratio: #{$ratio}:1";
  @debug "  WCAG AA (normal): #{$aa-normal}";
  @debug "  WCAG AAA (normal): #{$aaa-normal}";
}

// =============================================================================
// USAGE EXAMPLES
// =============================================================================

// Example 1: Create a color
// $primary-500: create-color($config, $custom, $base, 'primary', 500);
//
// Example 2: Check contrast
// $ratio: contrast-ratio(#000, #fff); // => 21
//
// Example 3: Auto text color
// $text: auto-text-color($primary-500); // => #fff or #000
//
// Example 4: Generate hover state
// $hover: hover-color($config, $custom, $base, 'primary', 500);
//
// Example 5: Find accessible weight
// $weight: accessible-weight($config, $custom, $base, 'primary', #fff, 'AA');
// $text-color: create-color($config, $custom, $base, 'primary', $weight);
//
// Example 6: Contrast report (debugging)
// @include contrast-report($primary-500, #ffffff);
