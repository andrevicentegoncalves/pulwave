#!/usr/bin/env node
/**
 * Generate Supabase Database Types
 *
 * Usage:
 *   1. First run: npx supabase login
 *   2. Then run: node scripts/generate-db-types.js
 *
 * This generates TypeScript types from your Supabase schema.
 */

import { execSync } from 'child_process';
import { writeFileSync, mkdirSync } from 'fs';
import { dirname } from 'path';

const PROJECT_ID = 'priwfadesatulapmzmpy';
const OUTPUT_PATH = 'packages/shared/types/src/database.types.ts';

console.log('üîÑ Generating Supabase database types...\n');

try {
    // Generate types
    const types = execSync(
        `npx supabase gen types typescript --project-id ${PROJECT_ID}`,
        { encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 }
    );

    // Ensure directory exists
    mkdirSync(dirname(OUTPUT_PATH), { recursive: true });

    // Write to file with header
    const header = `/**
 * Supabase Database Types
 *
 * Auto-generated by: node scripts/generate-db-types.js
 * Generated at: ${new Date().toISOString()}
 *
 * DO NOT EDIT MANUALLY - regenerate using the script above
 */

`;

    writeFileSync(OUTPUT_PATH, header + types);

    console.log(`‚úÖ Types generated successfully!`);
    console.log(`   Output: ${OUTPUT_PATH}\n`);
    console.log('Usage in your code:');
    console.log('  import type { Database } from "@pulwave/types";');
    console.log('  import type { Tables } from "@pulwave/types";\n');
} catch (error) {
    if (error.message?.includes('Access token not provided')) {
        console.error('‚ùå Not logged in to Supabase!\n');
        console.log('Run the following command first:');
        console.log('  npx supabase login\n');
        console.log('Then try again.');
    } else {
        console.error('‚ùå Error generating types:', error.message);
    }
    process.exit(1);
}
